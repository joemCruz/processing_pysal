import pysal 
import numpy as np
import processing 
from processing.tools.vector import VectorWriter
from qgis.core import *
from PyQt4.QtCore import *
from processing.core.GeoAlgorithm import GeoAlgorithm
from processing.core.parameters import *
from processing.core.outputs import *
from processing.tools import dataobjects

class Markov(GeoAlgorithm):

    INPUT = 'INPUT'
    FIELD = 'FIELD'
    CONTIGUITY = 'CONTIGUITY'
    MARKOV_T = 'MARKOV_T'
    TRANSITIONS = 'TRANSITIONS'

    def defineCharacteristics(self):
        self.name = "Markov"
        self.group = 'Spatial Dynamics'

        ##input=vector
        ##field=field input
        ##contiguity=selection queen;rook
        ##i=output number 

        self.addParameter(ParameterVector(self.INPUT,
            self.tr('Input layer'), [ParameterVector.VECTOR_TYPE_POLYGON]))
        #Added Markov parameter
        self.addParameter(ParameterSelection(self.MARKOV_T,
            self.tr('Markov Type'), ['Classic', 'Spatial', 'LISA']))
        self.addParameter(ParameterTableField(self.FIELD,
            self.tr('Field'), self.INPUT))
        self.addParameter(ParameterSelection(self.CONTIGUITY,
            self.tr('Contiguity'), ["Queen","Rook"]))

        self.addOutput(OutputNumber(self.TRANSITIONS, self.tr('transitions')))
        
    def processAlgorithm(self, progress):
        field = self.getParameterValue(self.FIELD)
        field = field[0:10] # try to handle Shapefile field length limit
        filename = self.getParameterValue(self.INPUT)
        layer = dataobjects.getObjectFromUri(filename)
        filename = dataobjects.exportVectorLayer(layer)        
        
        contiguity = self.getParameterValue(self.CONTIGUITY)
        markov_type = self.getParameterValue(self.MARKOV_T)

        if markov_type != 0: # Not Classic Markov
            if contiguity == 0: # queen
                print 'INFO: {0} Markov using queen contiguity'.format(markov_type)
                w = pysal.queen_from_shapefile(filename)
            else: # 1 for rook
                print 'INFO: {0} Markov using rook contiguity'.format(markov_type)
                w = pysal.rook_from_shapefile(filename)
    
        f = pysal.open(filename.replace('.shp','.dbf'))
        y = np.array(f.by_col[str(field)])
        m = pysal.Markov(y)

        self.setOutputValue(self.transitions, m.transitions)
        
        print "Markov: %f" % (m.transitions)
        """
        print "INFO: Moran's I values range from -1 (indicating perfect dispersion) to +1 (perfect correlation). Values close to -1/(n-1) indicate a random spatial pattern."
        print "p_norm: %f" % (m.p_norm)
        print "p_rand: %f" % (m.p_rand)
        print "p_sim: %f" % (m.p_sim)
        print "INFO: p values smaller than 0.05 indicate spatial autocorrelation that is significant at the 5% level."
        print "z_norm: %f" % (m.z_norm)
        print "z_rand: %f" % (m.z_rand)
        print "z_sim: %f" % (m.z_sim)
        print "INFO: z values greater than 1.96 or smaller than -1.96 indicate spatial autocorrelation that is significant at the 5% level."
        """
